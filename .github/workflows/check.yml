# GitHub Actions Workflow for Python Projects
#
# This workflow performs basic checks on pull requests:
# 1. Lints the code with Flake8 to ensure style consistency.
# 2. Scans for security vulnerabilities with Bandit.
# 3. Checks dependencies for known vulnerabilities with pip-audit.

name: Python CI & Security Scan

on:
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 bandit pip-audit jq
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Lint with Flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Security scan with Bandit
      run: |
        # Step 1: Run Bandit and save the report as a JSON file.
        # --exit-zero ensures that Bandit always exits with 0, even if issues are found.
        # This allows our 'jq' script to handle the failure logic.
        bandit -r . -f json -o bandit-report.json --exit-zero
        
        # Step 2: Print the report to the logs for easy viewing.
        echo "--- Bandit Scan Report ---"
        cat bandit-report.json
        echo "--------------------------"
        
        # Step 3: Use jq to check if there are any HIGH or MEDIUM severity issues.
        # If jq finds any, it will exit with code 0. The 'if' condition will be true.
        if jq -e '.results | map(select(.issue_severity == "HIGH" or .issue_severity == "MEDIUM")) | length > 0' bandit-report.json; then
          echo "::error::Bandit found high or medium severity security issues. Failing the build."
          exit 1
        else
          echo "Bandit scan passed. No high or medium severity issues found."
        fi
        
    - name: Dependency vulnerability scan with pip-audit
      run: |
        pip-audit
