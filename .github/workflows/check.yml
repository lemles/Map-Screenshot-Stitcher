# GitHub Actions Workflow for Python Projects
#
# This workflow performs basic checks on pull requests:
# 1. Lints the code with Flake8 to ensure style consistency.
# 2. Scans for security vulnerabilities with Bandit.
# 3. Checks dependencies for known vulnerabilities with pip-audit.

name: Python CI & Security Scan

# Trigger this workflow on every pull request to the 'main' branch
on:
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    # Run on the latest version of Ubuntu
    runs-on: ubuntu-latest

    steps:
    # Step 1: Check out the repository code
    - name: Checkout repository
      uses: actions/checkout@v4

    # Step 2: Set up a specific version of Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' # Specify a Python version

    # Step 3: Install necessary Python packages for checking
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 bandit pip-audit
        # Install the project's own dependencies from requirements.txt
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    # Step 4: Lint code with Flake8 (checks for style errors)
    - name: Lint with Flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    # Step 5: Scan for security vulnerabilities with Bandit
    - name: Security scan with Bandit
      run: |
        pip install jq
        # Scan for vulnerabilities.
        # -r .: Recursively scan the current directory.
        # -lll: Report issues of HIGH severity.
        # -ll: Report issues of MEDIUM severity or higher.
        # --exit-code 1: If any issues are found at the specified level, exit with status 1, which fails the CI step.
        bandit -r . -ll --exit-code 1
        
    # Step 6: Scan dependencies for vulnerabilities with pip-audit
    - name: Dependency vulnerability scan with pip-audit
      run: |
        pip-audit
